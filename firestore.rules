rules_version = '2';

service cloud.firestore {
  // 관리자 이메일 목록 (VITE_KORAID_ADMIN_EMAILS와 동기화 유지 필요)
  // 아래에 관리자 이메일을 추가하세요 (소문자로)
  function isAdminEmail() {
    return request.auth != null && 
      request.auth.token.email != null &&
      (
        // 관리자 이메일 목록을 여기에 추가
        request.auth.token.email == 'archaimbaud08@gmail.com' ||
        request.auth.token.email == 'merci@ajou.ac.kr'
        // 추가 관리자 이메일을 위와 같은 형식으로 추가하세요
      );
  }

  match /databases/{database}/documents {
    match /trends/{trendId} {
      allow read: if true;
      allow write: if isAdminEmail();
    }

    match /events/{eventId} {
      allow read: if true;
      allow write: if isAdminEmail();
    }

    match /phrases/{phraseId} {
      allow read: if true;
      allow write: if isAdminEmail();
    }

    match /popups/{popupId} {
      allow read: if true;
      allow write: if isAdminEmail();
    }

    match /feedback/{feedbackId} {
      // 익명 제출 허용 (요청에 따라 조정 가능)
      allow create: if true;
      // 읽기는 인증된 사용자만
      allow read: if request.auth != null;
    }

    match /waitlist/{waitlistId} {
      // 익명 제출 허용 (누구나 waitlist 등록 가능)
      allow create: if true;
      // 읽기는 인증된 사용자만 (관리자용)
      allow read: if request.auth != null;
    }

    match /courses/{courseId} {
      allow read: if true;
      allow write: if isAdminEmail();
    }

    match /enrollments/{enrollmentId} {
      // 본인의 등록만 읽기 가능
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // 본인의 등록만 생성 가능
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // 본인의 등록만 수정 가능 (결제 상태 업데이트 등)
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      // 삭제는 허용하지 않음
      allow delete: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
